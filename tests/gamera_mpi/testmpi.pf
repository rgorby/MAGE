module testMpi
  use pFUnit
  use gamapp_mpi
  use usergamic

  implicit none

  type(gamAppMpi_T), allocatable :: gamAppMpi

contains

  @before
  subroutine setup(this)
      class (MpiTestMethod), intent(inout) :: this
      character(len=strLen) :: caseFile

      call setMpiReal()

      write(caseFile,'(A,I0,A)') 'blast3d_', this%getNumProcesses(), '.xml'

      allocate(gamAppMpi)
      call initGamera_mpi(gamAppMpi, initUser, this%getMpiCommunicator(), caseFile, .false.)

  end subroutine setup

  @after
  subroutine teardown(this)
      class (MpiTestMethod), intent(inout) :: this

      deallocate(gamAppMpi)

  end subroutine teardown

  @test(npes=[1,4,16,64])
  subroutine testTiling(this)
      class (MpiTestMethod), intent(inout) :: this

      integer :: i,j,k
      real(rp) :: checkVal
      character(len=strLen) :: checkMessage

      SELECT CASE(this%getNumProcesses())
          CASE (1)
              @assertFalse(gamAppMpi%Grid%isTiled, '1 processor isTiled wrong')

              @assertEqual(1, gamAppMpi%Grid%NumRi, '1 processor NumRi wrong')
              @assertEqual(1, gamAppMpi%Grid%NumRj, '1 processor NumRj wrong')
              @assertEqual(1, gamAppMpi%Grid%NumRk, '1 processor NumRk wrong')

              @assertEqual(0, gamAppMpi%Grid%Ri, '1 processor Ri wrong')
              @assertEqual(0, gamAppMpi%Grid%Rj, '1 processor Rj wrong')
              @assertEqual(0, gamAppMpi%Grid%Rk, '1 processor Rk wrong')

              @assertEqual((/0,0,0/), gamAppMpi%Grid%ijkShift, '1 processor ijkShift wrong')
              @assertTrue(gamAppMpi%Grid%hasLowerBC(IDIR), '1 processor hasLowerBC(IDIR) wrong')
              @assertTrue(gamAppMpi%Grid%hasLowerBC(JDIR), '1 processor hasLowerBC(JDIR) wrong')
              @assertTrue(gamAppMpi%Grid%hasLowerBC(KDIR), '1 processor hasLowerBC(KDIR) wrong')
              @assertTrue(gamAppMpi%Grid%hasUpperBC(IDIR), '1 processor hasUpperBC(IDIR) wrong')
              @assertTrue(gamAppMpi%Grid%hasUpperBC(JDIR), '1 processor hasUpperBC(JDIR) wrong')
              @assertTrue(gamAppMpi%Grid%hasUpperBC(KDIR), '1 processor hasUpperBC(KDIR) wrong')

              @assertEqual(4,  gamAppMpi%Model%Ng, '1 processor Ng wrong')
              @assertEqual(16, gamAppMpi%Grid%Nip, '1 processor Nip wrong')
              @assertEqual(16, gamAppMpi%Grid%Njp, '1 processor Njp wrong')
              @assertEqual(16, gamAppMpi%Grid%Nkp, '1 processor Nkp wrong')
              @assertEqual(24, gamAppMpi%Grid%Ni,  '1 processor Ni wrong')
              @assertEqual(24, gamAppMpi%Grid%Nj,  '1 processor Nj wrong')
              @assertEqual(24, gamAppMpi%Grid%Nk,  '1 processor Nk wrong')
              @assertEqual(1,  gamAppMpi%Grid%is,  '1 processor is wrong')
              @assertEqual(16, gamAppMpi%Grid%ie,  '1 processor ie wrong')
              @assertEqual(1,  gamAppMpi%Grid%js,  '1 processor js wrong')
              @assertEqual(16, gamAppMpi%Grid%je,  '1 processor je wrong')
              @assertEqual(1,  gamAppMpi%Grid%ks,  '1 processor ks wrong')
              @assertEqual(16, gamAppMpi%Grid%ke,  '1 processor ke wrong')
              @assertEqual(-3, gamAppMpi%Grid%isg, '1 processor isg wrong')
              @assertEqual(20, gamAppMpi%Grid%ieg, '1 processor ieg wrong')
              @assertEqual(-3, gamAppMpi%Grid%jsg, '1 processor jsg wrong')
              @assertEqual(20, gamAppMpi%Grid%jeg, '1 processor jeg wrong')
              @assertEqual(-3, gamAppMpi%Grid%ksg, '1 processor ksg wrong')
              @assertEqual(20, gamAppMpi%Grid%keg, '1 processor keg wrong')

              do i=gamAppMpi%Grid%isg,gamAppMpi%Grid%ieg+1
                  do j=gamAppMpi%Grid%jsg,gamAppMpi%Grid%jeg+1
                      do k=gamAppMpi%Grid%ksg,gamAppMpi%Grid%keg+1
                          checkVal = -0.5_rp+(i-1)*(1.0_rp/16.0_rp)
                          write (checkMessage,'(A,I0,A,I0,A,I0,A)') '1 processor x wrong at (',i,',',j,',',k,')'
                          @assertEqual(checkVal, gamAppMpi%Grid%x(i,j,k), trim(checkMessage))
                          checkVal = -0.5_rp+(j-1)*(1.0_rp/16.0_rp)
                          write (checkMessage,'(A,I0,A,I0,A,I0,A)') '1 processor y wrong at (',i,',',j,',',k,')'
                          @assertEqual(checkVal, gamAppMpi%Grid%y(i,j,k), trim(checkMessage))
                          checkVal = -0.5_rp+(k-1)*(1.0_rp/16.0_rp)
                          write (checkMessage,'(A,I0,A,I0,A,I0,A)') '1 processor z wrong at (',i,',',j,',',k,')'
                          @assertEqual(checkVal, gamAppMpi%Grid%z(i,j,k), trim(checkMessage))
                      enddo
                  enddo
              enddo
          CASE (4)
              @assertTrue(gamAppMpi%Grid%isTiled, '4 processor isTiled wrong')
              @assertEqual(gamAppMpi%Grid%NumRi, 4, '4 processor NumRi wrong')
              @assertEqual(gamAppMpi%Grid%NumRj, 1, '4 processor NumRj wrong')
              @assertEqual(gamAppMpi%Grid%NumRk, 1, '4 processor NumRk wrong')
          CASE (16)
              @assertTrue(gamAppMpi%Grid%isTiled, '16 processor isTiled wrong')
              @assertEqual(gamAppMpi%Grid%NumRi, 4, '16 processor NumRi wrong')
              @assertEqual(gamAppMpi%Grid%NumRj, 4, '16 processor NumRj wrong')
              @assertEqual(gamAppMpi%Grid%NumRk, 1, '16 processor NumRk wrong')
          CASE (64)
              @assertTrue(gamAppMpi%Grid%isTiled, '64 processor isTiled wrong')
              @assertEqual(gamAppMpi%Grid%NumRi, 4, '64 processor NumRi wrong')
              @assertEqual(gamAppMpi%Grid%NumRj, 4, '64 processor NumRj wrong')
              @assertEqual(gamAppMpi%Grid%NumRk, 4, '64 processor NumRk wrong')
          CASE DEFAULT
              @assertEqual(0, 1, 'Unexpected number of MPI processes')
      END SELECT
  end subroutine testTiling

end module testMpi

